<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perps/Derivatives DEX Competitors Benchmark</title>
  <style>
    :root { --bg:transparent; --card:#1a1d22; --muted:#9aa4b2; --fg:#e8eef7; --down:#ec5c5c; --up:#3fb87f; --accent:#2e323a; }
    *{box-sizing:border-box}
    body{margin:0;background:transparent;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--fg);}
    .card{max-width:760px;margin:24px auto;background:var(--card);border:1px solid #22262e;border-radius:0;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    header{display:flex;align-items:center;gap:14px;margin-bottom:8px}
    header img{width:42px;height:42px}
    header h1{font-size:26px;margin:0;font-weight:700;letter-spacing:.5px}
    .section-title{font-size:18px;margin:14px 0 8px; font-weight:800}
    .hr{height:1px;background:#282c35;margin:10px 0}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th, td{padding:12px;text-align:left;border-bottom:1px solid #282c35;vertical-align:top;}
    th{font-weight:700;color:var(--muted)}
    td{font-weight:600;}
    .protocol{display:flex;align-items:center;gap:8px}
    .protocol img{width:24px;height:24px;border-radius:0}
    .foot{margin-top:10px;color:#7d8897;font-size:12px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    a{color:#9cc9ff;text-decoration:none}
    .sort-controls { display: flex; gap: 10px; margin-bottom: 10px; }
    button { background: var(--accent); color: var(--fg); border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
    select { background: var(--accent); color: var(--fg); border: 1px solid #22262e; padding: 8px; border-radius: 4px; }
  </style>
</head>
<body>
  <div class="card" id="widget" data-vs="usd">
    <header>
      <h1>Perps/Derivatives DEX Competitors Benchmark</h1>
    </header>
    <div class="section-title">Key Metrics</div>
    <div class="hr"></div>
    <div class="sort-controls">
      <select id="sortBy">
        <option value="name">Protocol</option>
        <option value="foundationYear">Est.</option>
        <option value="tvl">TVL</option>
        <option value="market_cap">Market Cap</option>
        <option value="fdv">FDV</option>
        <option value="volume">Volume 24h</option>
      </select>
      <select id="sortOrder">
        <option value="asc">Ascending</option>
        <option value="desc">Descending</option>
      </select>
      <button onclick="sortAndRender()">Sort</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Protocol</th>
          <th>Est.</th>
          <th>TVL</th>
          <th>Market Cap</th>
          <th>FDV</th>
          <th>Volume 24h</th>
        </tr>
      </thead>
      <tbody id="table-body">
        <!-- Rows will be populated here -->
      </tbody>
    </table>
    <div class="foot">
      <div>Data from CoinGecko (MCAP, FDV, VOL) and DefiLlama (TVL, as of October 20, 2025).</div>
    </div>
  </div>
  <script>
    let coinsData = [];
    let marketMap = new Map();

    async function fetchJSON(url){ 
      const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
      const res = await fetch(proxyUrl, {headers:{'accept':'application/json'}, mode: 'cors'}); 
      if(!res.ok) throw new Error('HTTP '+res.status); 
      return res.json(); 
    }
    function fmtUSD(n){ if(n===null||n===undefined) return '—'; const abs=Math.abs(n); if(abs>=1e12) return '$'+(n/1e12).toFixed(2)+'T'; if(abs>=1e9) return '$'+(n/1e9).toFixed(2)+'B'; if(abs>=1e6) return '$'+(n/1e6).toFixed(2)+'M'; if(abs>=1e3) return '$'+(n/1e3).toFixed(2)+'K'; return '$'+n.toLocaleString(undefined,{maximumFractionDigits:2}); }

    function renderTable(coins) {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';
      coins.forEach(coin => {
        const market = coin.market;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="protocol"><img src="${market?.image || ''}" alt="${coin.name} logo" /><span>${coin.name}</span></td>
          <td>${coin.foundationYear || '—'}</td>
          <td>${fmtUSD(coin.tvl)}</td>
          <td>${fmtUSD(market?.market_cap)}</td>
          <td>${fmtUSD(market?.fully_diluted_valuation)}</td>
          <td>${fmtUSD(market?.total_volume)}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function sortAndRender() {
      const sortBy = document.getElementById('sortBy').value;
      const sortOrder = document.getElementById('sortOrder').value;
      const sorted = [...coinsData].sort((a, b) => {
        let valA, valB;
        if (sortBy === 'name') {
          valA = a.name || '';
          valB = b.name || '';
          return sortOrder === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
        } else if (sortBy === 'foundationYear') {
          valA = parseInt(a.foundationYear || 0);
          valB = parseInt(b.foundationYear || 0);
        } else if (sortBy === 'tvl') {
          valA = a.tvl || 0;
          valB = b.tvl || 0;
        } else if (sortBy === 'market_cap') {
          valA = a.market?.market_cap || 0;
          valB = b.market?.market_cap || 0;
        } else if (sortBy === 'fdv') {
          valA = a.market?.fully_diluted_valuation || 0;
          valB = b.market?.fully_diluted_valuation || 0;
        } else if (sortBy === 'volume') {
          valA = a.market?.total_volume || 0;
          valB = b.market?.total_volume || 0;
        }
        if (isNaN(valA)) valA = 0;
        if (isNaN(valB)) valB = 0;
        return sortOrder === 'asc' ? valA - valB : valB - valA;
      });
      renderTable(sorted);
    }

    (async function init(){
      const root = document.getElementById('widget');
      const vs = root.dataset.vs || 'usd';
      const coins = [
        { id: 'hyperliquid', name: 'Hyperliquid', slug: 'hyperliquid', foundationYear: '2023', tvl: 4787000000 },
        { id: 'aster-2', name: 'Aster', slug: 'aster', foundationYear: '2025', tvl: 1891000000 },
        { id: 'dydx-chain', name: 'dYdX', slug: 'dydx-v4', foundationYear: '2017', tvl: 186760000 },
        { id: 'gmx', name: 'GMX', slug: 'gmx', foundationYear: '2021', tvl: 558000000 }
      ];
      try {
        // Fetch market data for all coins
        const ids = coins.map(c => c.id).filter(id => id).join(',');
        const marketsURL = `https://api.coingecko.com/api/v3/coins/markets?vs_currency=${vs}&ids=${encodeURIComponent(ids)}&sparkline=false&price_change_percentage=24h`;
        const marketData = await fetchJSON(marketsURL);
        marketMap = new Map(marketData.map(coin => [coin.id, coin]));

        coinsData = coins.map(c => ({
          ...c,
          market: marketMap.get(c.id)
        }));

        renderTable(coinsData);
      } catch(err){
        console.error(err);
        // Fill with placeholders on error
        const tbody = document.getElementById('table-body');
        coins.forEach(coin => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="protocol"><img src="" alt="${coin.name} logo" /><span>${coin.name}</span></td>
            <td>${coin.foundationYear || '—'}</td>
            <td>${fmtUSD(coin.tvl)}</td>
            <td>—</td>
            <td>—</td>
            <td>—</td>
          `;
          tbody.appendChild(row);
        });
      }
    })();
  </script>
</body>
</html>
